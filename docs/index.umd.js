(function(i,d){typeof exports=="object"&&typeof module<"u"?d(exports):typeof define=="function"&&define.amd?define(["exports"],d):(i=typeof globalThis<"u"?globalThis:i||self,d(i.stretto={}))})(this,(function(i){"use strict";var q=Object.defineProperty;var K=(i,d,h)=>d in i?q(i,d,{enumerable:!0,configurable:!0,writable:!0,value:h}):i[d]=h;var _=(i,d,h)=>K(i,typeof d!="symbol"?d+"":d,h);/*!
 * stretto v1.0.26
 * (c) 2025
 * Contributors: @haikelfazzani
 * Released under the MIT License
 */const d="Body has already been consumed.",h=Symbol.asyncIterator;function A(n,e,t){if(!n.body)return n;let c=!1;const u=e.length>0?e.reduce((r,o)=>r.pipeThrough(o),n.body):n.body,l=async function*(){if(c)throw new Error(d);c=!0;const r=u.getReader(),o=()=>{r.cancel(t==null?void 0:t.reason).catch(s=>{s.name!=="TypeError"&&console.warn("StrettoStreamableResponse: An unexpected error occurred during stream cancellation.",s)})};t==null||t.addEventListener("abort",o,{once:!0});try{for(;;){const{done:s,value:y}=await r.read();if(s)return;yield y}}finally{t==null||t.removeEventListener("abort",o),r.releaseLock()}},T={get(r,o){if(o===h)return l;const s=Reflect.get(r,o);return typeof s=="function"?s.bind(r):s}};return new Proxy(n,T)}class x extends Error{constructor(t){super(`HTTP Error: ${t.status} ${t.statusText}`);_(this,"response");this.name="HTTPError",this.response=t}}const v=100,M=5e3,p="AbortError",I="TimeoutError",D="Connection timeout",L=new Set([408,429,500,502,503,504]),N=(n,e)=>new Promise((t,c)=>{if(e!=null&&e.aborted){c(e.reason??new DOMException("Sleep aborted","AbortError"));return}const u=setTimeout(t,n);if(e){const l=()=>{clearTimeout(u),c(e.reason??new DOMException("Sleep aborted","AbortError"))};e.addEventListener("abort",l,{once:!0})}}),P=n=>{const t=(v<<n-1)*Math.random();return Math.min(M,t)},B=(n,e)=>n instanceof DOMException&&n.name===p?!1:!!(e&&L.has(e.status)||n instanceof TypeError&&n.message==="Failed to fetch"),U=(n,e)=>{const t=new AbortController;if(e!=null&&e.aborted)return t.abort(e.reason),{signal:t.signal,cleanup:()=>{}};let c;const u=()=>{c&&clearTimeout(c),t.abort(e==null?void 0:e.reason)};n>0&&n!==1/0&&(c=setTimeout(()=>{t.abort(new DOMException(D,I))},n)),e&&e.addEventListener("abort",u,{once:!0});const l=()=>{c&&clearTimeout(c),e==null||e.removeEventListener("abort",u)};return{signal:t.signal,timeoutId:c,cleanup:l}},C=3,F=3e4,S="Request aborted by user";async function k(n,e={}){var y;const{retries:t=C,timeout:c=F,backoffStrategy:u=P,retryOn:l=B,stream:T=!1,transformers:r=[],...o}=e,s=o.signal;for(let f=0;f<=t;f++){if(s!=null&&s.aborted)throw s.reason??new DOMException(S,p);const{signal:m,cleanup:E}=U(c,s),w={...o,signal:m};try{f>0&&await N(u(f),m);const a=await fetch(n,w);if(a.ok)return T?A(a,r,s):a;if(await((y=a.body)==null?void 0:y.cancel()),f<t&&l(void 0,a))continue;throw new x(a)}catch(a){if(f<t&&l(a,void 0))continue;throw a}finally{E()}}throw new Error("Stretto retry loop exited unexpectedly.")}const J=10,j=13,O=6,H=new TextDecoder,G=new TextEncoder;function $(n,e,t){if(e+t.length>n.length)return!1;for(let c=0;c<t.length;c++)if(n[e+c]!==t[c])return!1;return!0}class Y extends TransformStream{constructor(e={}){const t=Math.max(64,e.maxBuffer||8192),c=e.parseData??!0,u=e.onBufferOverflow??"skip",l=e.onParseError??"skip",T=e.donePrefix?G.encode(e.donePrefix):null,r=new Uint8Array(t);let o=0;super({transform:(s,y)=>{let f=0;const m=s.length;for(;f<m;){let E=s.indexOf(J,f);E===-1&&(E=m);const w=E-f;if(o+w>t){if(u==="throw")throw r.fill(0,0,o),new RangeError(`JSONStreamTransformer Buffer Overflow: Line exceeds ${t} byte limit (${o+w} bytes). Increase 'maxBuffer' option or validate input stream.`);o=0,f=E<m?E+1:m;continue}if(w>0&&(r.set(s.subarray(f,E),o),o+=w),E<m){if(o>=O&&r[0]===100&&r[1]===97&&r[2]===116&&r[3]===97&&r[4]===58&&r[5]===32){const a=O;let b=o-a;if(b>0&&r[a+b-1]===j&&b--,b>0){if(T&&b===T.length&&$(r,a,T)||!T&&b===6&&r[a]===91&&r[a+1]===68&&r[a+2]===79&&r[a+3]===78&&r[a+4]===69&&r[a+5]===93){r.fill(0,0,o),o=0,y.terminate();return}try{const R=H.decode(r.subarray(a,a+b));y.enqueue(c?JSON.parse(R):R)}catch{if(l==="throw"){r.fill(0,0,o),y.error(new TypeError("Invalid JSON payload received in SSE stream."));return}console.warn("Invalid JSON payload received in SSE stream and was skipped.")}}}o=0,f=E+1}else f=m}},flush:()=>{o>0&&(r.fill(0,0,o),o=0)}})}}i.JSONStreamTransformer=Y,i.default=k,Object.defineProperties(i,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
