(function(f,l){typeof exports=="object"&&typeof module<"u"?l(exports):typeof define=="function"&&define.amd?define(["exports"],l):(f=typeof globalThis<"u"?globalThis:f||self,l(f.stretto={}))})(this,(function(f){"use strict";var q=Object.defineProperty;var K=(f,l,R)=>l in f?q(f,l,{enumerable:!0,configurable:!0,writable:!0,value:R}):f[l]=R;var p=(f,l,R)=>K(f,typeof l!="symbol"?l+"":l,R);/*!
 * stretto v1.0.24
 * (c) 2025
 * Contributors: @haikelfazzani
 * Released under the MIT License
 */const l="Body has already been consumed.",R=Symbol.asyncIterator;function v(r,e,t){if(!r.body)return r;let a=!1;const E={},y=e.length>0?e.reduce((o,n)=>o.pipeThrough(n),r.body):r.body,m={get(o,n){if(n===R)return async function*(){if(a)throw new Error(l);a=!0;const T=y.getReader(),c=()=>{T.cancel(t==null?void 0:t.reason).catch(()=>{})};t==null||t.addEventListener("abort",c,{once:!0});try{for(;;){const{done:h,value:d}=await T.read();if(h)return;yield d}}finally{t==null||t.removeEventListener("abort",c),T.releaseLock()}};const s=Reflect.get(o,n);return typeof s=="function"?(E[n]||(E[n]=s.bind(o)),E[n]):s}};return new Proxy(r,m)}class A extends Error{constructor(t){super(`HTTP Error: ${t.status} ${t.statusText}`);p(this,"response");this.name="HTTPError",this.response=t}}const x=100,M=5e3,O="AbortError",D="TimeoutError",I="Connection timeout",B=new Set([408,429,500,502,503,504]),N=r=>new Promise(e=>setTimeout(e,r)),P=r=>{const t=(x<<r-1)*Math.random();return Math.min(M,t)},L=(r,e)=>r instanceof DOMException&&r.name===O?!1:!!(e&&B.has(e.status)||r instanceof TypeError&&r.message==="Failed to fetch"),U=(r,e)=>{const t=new AbortController;if(e!=null&&e.aborted)return t.abort(e.reason),{signal:t.signal,cleanup:()=>{}};let a;const E=()=>{a&&clearTimeout(a),t.abort(e==null?void 0:e.reason)};r>0&&r!==1/0&&(a=setTimeout(()=>{t.abort(new DOMException(I,D))},r)),e&&e.addEventListener("abort",E,{once:!0});const y=()=>{a&&clearTimeout(a),e==null||e.removeEventListener("abort",E)};return{signal:t.signal,timeoutId:a,cleanup:y}},C=3,k=3e4,F="Request aborted by user";async function j(r,e={}){var T;const{retries:t=C,timeout:a=k,backoffStrategy:E=P,retryOn:y=L,stream:m=!1,transformers:o=[],...n}=e,s=n.signal;for(let c=0;c<=t;c++){if(s!=null&&s.aborted)throw s.reason??new DOMException(F,O);const{signal:h,cleanup:d}=U(a,s);n.signal=h;try{c>0&&await N(E(c));const i=await fetch(r,n);if(i.ok)return m?v(i,o,s):i;if(await((T=i.body)==null?void 0:T.cancel()),c<t&&y(void 0,i))continue;throw new A(i)}catch(i){if(c<t&&y(i,void 0))continue;throw i}finally{d()}}throw new Error("Stretto retry loop exited unexpectedly.")}const J=10,$=13,_=6,G=new TextDecoder,H=new TextEncoder;function S(r,e,t){if(e+t.length>r.length)return!1;for(let a=0;a<t.length;a++)if(r[e+a]!==t[a])return!1;return!0}class Y extends TransformStream{constructor(e={}){const t=Math.max(64,e.maxBuffer||8192),a=e.parseData??!0,E=e.onBufferOverflow??"skip",y=e.onParseError??"skip",m=e.donePrefix?H.encode(e.donePrefix):null,o=new Uint8Array(t);let n=0;super({transform:(s,T)=>{let c=0;const h=s.length;for(;c<h;){let d=s.indexOf(J,c);d===-1&&(d=h);const i=d-c;if(n+i>t){if(E==="throw")throw o.fill(0,0,n),new RangeError(`Buffer overflow: An SSE line exceeds the configured maxBuffer of ${t} bytes. The oversized line starts at offset ${c} in the current data chunk and would have resulted in a total line length of at least ${n+i} bytes. To process larger lines, increase the 'maxBuffer' option. This error can also indicate a protocol violation or malicious input.`);n=0,c=d<h?d+1:h;continue}if(i>0&&(o.set(s.subarray(c,d),n),n+=i),d<h){if(n>=_&&o[0]===100&&o[1]===97&&o[2]===116&&o[3]===97&&o[4]===58&&o[5]===32){const u=_;let w=n-u;if(w>0&&o[u+w-1]===$&&w--,w>0){if(m&&w===m.length&&S(o,u,m)||!m&&w===6&&o[u]===91&&o[u+1]===68&&o[u+2]===79&&o[u+3]===78&&o[u+4]===69&&o[u+5]===93){o.fill(0,0,n),n=0,T.terminate();return}try{const b=G.decode(o.subarray(u,u+w));T.enqueue(a?JSON.parse(b):b)}catch{if(y==="throw"){o.fill(0,0,n),T.error(new TypeError("Invalid JSON payload received in SSE stream."));return}console.warn("Invalid JSON payload received in SSE stream and was skipped.")}}}n=0,c=d+1}else c=h}},flush:()=>{n>0&&(o.fill(0,0,n),n=0)}})}}f.JSONStreamTransformer=Y,f.default=j,Object.defineProperties(f,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
