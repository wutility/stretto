(function(f,a){typeof exports=="object"&&typeof module<"u"?a(exports):typeof define=="function"&&define.amd?define(["exports"],a):(f=typeof globalThis<"u"?globalThis:f||self,a(f.stretto={}))})(this,(function(f){"use strict";var et=Object.defineProperty;var st=(f,a,b)=>a in f?et(f,a,{enumerable:!0,configurable:!0,writable:!0,value:b}):f[a]=b;var n=(f,a,b)=>st(f,typeof a!="symbol"?a+"":a,b);class a extends Error{constructor(r,s){super(r);n(this,"response");this.name="HTTPError",this.response=s}}const b=o=>new Promise(t=>setTimeout(t,o)),N=100,R=5e3,L=2,z=o=>{const t=N*L**o,r=Math.min(R,t);return Math.random()*r},j=(o,t)=>{if(t){const r=t.status;if(r>=500&&r<600||[408,429,409].includes(r))return!0}return o instanceof Error?!(o instanceof DOMException&&o.name==="AbortError"):!1},D=(o,t)=>{const r=new AbortController;let s;const e=()=>r.abort(t==null?void 0:t.reason);t!=null&&t.aborted&&e(),o>0&&(s=setTimeout(()=>{r.abort(new DOMException("Connection timeout","TimeoutError"))},o)),t==null||t.addEventListener("abort",e);const i=()=>{s&&clearTimeout(s),t==null||t.removeEventListener("abort",e)};return{signal:r.signal,cleanup:i}},I=3,M=3e4,U=(o,t,r=[],s)=>{if(!t)return o;let e=!1;const i={get(h,m,u){if(m===Symbol.asyncIterator)return async function*(){if(e)throw new Error("Body has already been consumed.");const B=h.body;if(!B)return;e=!0;let d=B;for(const c of r)d=d.pipeThrough(c);const E=d.getReader(),p=()=>E.cancel(s==null?void 0:s.reason);s==null||s.addEventListener("abort",p);try{for(;;){if(s!=null&&s.aborted)throw s.reason??new DOMException("Request aborted by user","AbortError");const{done:c,value:C}=await E.read();if(c)break;yield C}}finally{s==null||s.removeEventListener("abort",p),E.releaseLock()}};const l=Reflect.get(h,m,u);return typeof l=="function"?l.bind(h):l}};return new Proxy(o,i)};async function H(o,t={}){const{retries:r=I,timeout:s=M,backoffStrategy:e=z,retryOn:i=j,stream:h=!1,transformers:m=[],signal:u,...l}=t;let B=new Error(`Request failed after ${r+1} attempts`);for(let d=0;d<=r;d++){if(u!=null&&u.aborted)throw u.reason??new DOMException("Request aborted by user","AbortError");const{signal:E,cleanup:p}=D(s,u);try{const c=await fetch(o,{...l,signal:E});if(!c.ok)throw new a(`HTTP ${c.status}: ${c.statusText}`,c);return p(),U(c,h,m,u)}catch(c){B=c;const C=c instanceof a?c.response:void 0;if(!i(c,C)||d===r)throw p(),B}p(),await b(e(d))}throw B}class x{constructor(t,r){n(this,"buffer");n(this,"writePos",0);n(this,"readPos",0);n(this,"_occupied",0);n(this,"mask");n(this,"maxSize");if(t<=0)throw new RangeError("initialSize must be positive.");if(r<t)throw new RangeError("maxSize must be >= initialSize.");const s=1<<31-Math.clz32(t-1|0);this.buffer=new Uint8Array(s),this.mask=s-1,this.maxSize=r}get occupied(){return this._occupied}peekByte(t){return this.buffer[this.readPos+t&this.mask]}write(t){const r=t.length;if(r>this.buffer.length-this._occupied&&!this.resize(r))return!1;const s=this.writePos,e=Math.min(r,this.buffer.length-s);return this.buffer.set(t.subarray(0,e),s),r-e>0&&this.buffer.set(t.subarray(e),0),this.writePos=s+r&this.mask,this._occupied+=r,!0}getView(t,r){const s=this.readPos+t&this.mask;return this.buffer.subarray(s,s+r)}consume(t){t<=0||(this._occupied-=t,this.readPos=this.readPos+t&this.mask)}matchSequence(t,r){for(let s=0;s<r.length;s++)if(this.peekByte(t+s)!==r[s])return!1;return!0}resize(t){const r=1<<31-Math.clz32(this._occupied+t-1|0);if(r>this.maxSize)return!1;const s=new Uint8Array(r);if(this._occupied>0){const e=this.readPos,i=this.writePos;if(e<i)s.set(this.buffer.subarray(e,i),0);else{const h=this.buffer.length-e;s.set(this.buffer.subarray(e),0),s.set(this.buffer.subarray(0,i),h)}}return this.buffer=s,this.readPos=0,this.writePos=this._occupied,this.mask=r-1,!0}}const J=new TextDecoder,y=10,F=32,V=13,v=123,q=125,T=91,K=93,$=92,X=34,O=2*1024,S=8*1024;class Y extends TransformStream{constructor(t){super(new G({minBufferSize:O,maxBufferSize:S,...t}))}}class G{constructor(t){n(this,"ringBuffer");n(this,"bracketCount",0);n(this,"braceCount",0);n(this,"inString",!1);n(this,"escapeNext",!1);n(this,"done",!1);n(this,"jsonStartPos",-1);n(this,"expectingArray",!1);this.ringBuffer=new x(t.minBufferSize??O,t.maxBufferSize??S)}transform(t,r){this.done||(this.ringBuffer.write(t),this.processBuffer(r))}flush(t){this.processBuffer(t,!0)}processBuffer(t,r=!1){const s=this.ringBuffer.occupied;let e=0;for(;e<s;){if(e+6<=s&&this.ringBuffer.matchSequence(e,[91,68,79,78,69,93])){this.done=!0,t.terminate(),this.ringBuffer.consume(e+6);return}const i=this.ringBuffer.peekByte(e);if(this.braceCount===0&&this.bracketCount===0&&this.jsonStartPos===-1){if(i===y||i===F){e++;continue}if(i===V){if(e+1<s&&this.ringBuffer.peekByte(e+1)===y){e+=2;continue}e++;continue}if(i===y){if(e+1<s&&this.ringBuffer.peekByte(e+1)===y){e+=2;continue}e++;continue}if(i===v||i===T){this.jsonStartPos=e,this.expectingArray=i===T,this.expectingArray?this.bracketCount=1:this.braceCount=1,this.inString=!1,this.escapeNext=!1,e++;continue}e++;continue}if(this.jsonStartPos!==-1){if(this.escapeNext)this.escapeNext=!1;else if(i===$)this.escapeNext=!0;else if(i===X)this.inString=!this.inString;else if(!this.inString){if(this.expectingArray){if(i===T)this.bracketCount++;else if(i===K&&--this.bracketCount===0){this.emitJSON(t,this.jsonStartPos,e+1),e++;continue}}else if(i===v)this.braceCount++;else if(i===q&&--this.braceCount===0){this.emitJSON(t,this.jsonStartPos,e+1),e++;continue}}}e++}this.jsonStartPos===-1?this.ringBuffer.consume(s):r&&this.braceCount===0&&this.bracketCount===0&&this.jsonStartPos!==-1?(this.emitJSON(t,this.jsonStartPos,s),this.ringBuffer.consume(s),this.jsonStartPos=-1):this.jsonStartPos>0&&(this.ringBuffer.consume(this.jsonStartPos),this.jsonStartPos=0)}emitJSON(t,r,s){const e=s-r;if(e<=0)return;const i=this.ringBuffer.getView(r,e),h=J.decode(i,{stream:!0});try{t.enqueue(JSON.parse(h))}catch{console.warn("Invalid JSON detected:",h)}this.jsonStartPos=-1,this.braceCount=0,this.bracketCount=0,this.expectingArray=!1}}const Q=new TextDecoder,P=10,g=13,W=58,Z=32,_=2*1024,k=8*1024;class tt extends TransformStream{constructor(t){super(new A({minBufferSize:_,maxBufferSize:k,...t}))}}const w=class w{constructor(t){n(this,"dataBufferParts",[]);n(this,"eventTypeBuffer","");n(this,"lastEventIdBuffer","");n(this,"parseData");n(this,"metadata");n(this,"ringBuffer");this.parseData=(t==null?void 0:t.parseData)??!1,this.metadata=(t==null?void 0:t.metadata)??!1,this.ringBuffer=new x(t.minBufferSize??_,t.maxBufferSize??k)}transform(t,r){this.ringBuffer.write(t),this.parseBuffer(r)}flush(){}parseBuffer(t){let r=0;const s=this.ringBuffer.occupied;let e=0;for(;e<s;){const i=this.ringBuffer.peekByte(e);if(i===P||i===g){const h=e-r;let m=1;if(i===g&&e+1<s&&this.ringBuffer.peekByte(e+1)===P&&(m=2),h>0){const u=this.ringBuffer.getView(r,h),l=Q.decode(u);this.processLine(l)}else this.dispatchEvent(t);e+=m,r=e;continue}e++}this.ringBuffer.consume(r)}processLine(t){if(t.charCodeAt(0)===W)return;const r=t.indexOf(":");let s,e;switch(r===-1?(s=t,e=""):(s=t.substring(0,r),e=t.substring(r+1),e.charCodeAt(0)===Z&&(e=e.substring(1))),s){case"event":this.eventTypeBuffer=e;break;case"data":this.dataBufferParts.push(e);break;case"id":e.indexOf("\0")===-1&&(this.lastEventIdBuffer=e);break}}dispatchEvent(t){if(this.dataBufferParts.length===0||this.dataBufferParts.length===1&&this.dataBufferParts[0]===""){this.resetEventBuffers();return}let r=this.dataBufferParts.join(`
`);r.charCodeAt(r.length-1)===P&&(r=r.slice(0,-1));let s=r;if(this.parseData)try{s=JSON.parse(r)}catch{}const e=this.metadata?{data:s,type:this.eventTypeBuffer||w.DEFAULT_EVENT_TYPE,lastEventId:this.lastEventIdBuffer}:s;t.enqueue(e),this.resetEventBuffers()}resetEventBuffers(){this.dataBufferParts.length=0,this.eventTypeBuffer=""}};n(w,"DEFAULT_EVENT_TYPE","message");let A=w;f.HTTPError=a,f.JSONStreamTransformer=Y,f.SSEStreamTransformer=tt,f.default=H,Object.defineProperties(f,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
