(function(u,a){typeof exports=="object"&&typeof module<"u"?module.exports=a():typeof define=="function"&&define.amd?define(a):(u=typeof globalThis<"u"?globalThis:u||self,u.stretto=a())})(this,(function(){"use strict";var H=Object.defineProperty;var J=(u,a,l)=>a in u?H(u,a,{enumerable:!0,configurable:!0,writable:!0,value:l}):u[a]=l;var _=(u,a,l)=>J(u,typeof a!="symbol"?a+"":a,l);const T=new TextDecoder,m=new TextEncoder,w=m.encode("data:"),A=m.encode("event:"),g=m.encode("id:"),B=r=>new Promise(e=>setTimeout(e,r)),I=r=>typeof r=="object"&&r!==null&&!Array.isArray(r)&&(Object.getPrototypeOf(r)===null||Object.getPrototypeOf(r)===Object.prototype),F=r=>r.status>=500&&r.status<600,D=r=>Math.min(5e3,100*Math.pow(2,r-1))*(.5+Math.random()*.5);async function M(r,e){const{body:t,headers:s={},retries:n=3,timeout:c=3e4,backoffStrategy:o=D,retryOn:i=F,signal:f,...L}=e;let h;for(let d=0;d<=n;d++){const p=new AbortController,O=p.signal,x=()=>p.abort(f==null?void 0:f.reason);f==null||f.addEventListener("abort",x,{once:!0});const X=c>0?setTimeout(()=>p.abort(new DOMException("Request timed out","TimeoutError")),c):0;try{d>0&&await B(o(d));const y=new Headers(s),E={...L,headers:y,signal:O};I(t)?(y.has("Content-Type")||y.set("Content-Type","application/json"),E.body=JSON.stringify(t)):E.body=t;const R=await fetch(r,E);if(d<n&&i(R.clone()))continue;return R}catch(y){if(h=y,O.aborted)throw h}finally{clearTimeout(X),f==null||f.removeEventListener("abort",x)}}throw h??new Error("Request failed after all retry attempts.")}const S=r=>{try{return JSON.parse(r)}catch{return null}},b=(r,e)=>{if(e.length>r.length)return!1;for(let t=0;t<e.length;t++)if(r[t]!==e[t])return!1;return!0},C=r=>r[0]===32?r.subarray(1):r;class N{constructor(){_(this,"sseBuffer",[])}parse(e,t){if(e.length===0){this.flushSseBuffer(t);return}if(b(e,w)){const c=T.decode(C(e.subarray(w.length)));this.sseBuffer.push(c);return}if(b(e,A)||b(e,g)||e[0]===58)return;this.flushSseBuffer(t);const s=T.decode(e),n=S(s)??s;t.enqueue(n)}flush(e){this.flushSseBuffer(e)}flushSseBuffer(e){if(this.sseBuffer.length===0)return;const t=this.sseBuffer.join(`
`);this.sseBuffer.length=0;const s=S(t)??t;e.enqueue(s)}}class j extends TransformStream{constructor(){let e=new Uint8Array(65536),t=0,s=0;super({transform:(n,c)=>{if(t+n.length>e.length){if(t+n.length>1048576)throw new Error("Line exceeds maximum length of 1048576 bytes");const o=Math.max(e.length*2,t+n.length),i=new Uint8Array(o);i.set(e.subarray(0,t)),e=i}e.set(n,t),t+=n.length;for(let o=s;o<t;o++)if(e[o]===10){const i=o>0&&e[o-1]===13?o-1:o;c.enqueue(e.subarray(s,i)),s=o+1}s>0&&(e.copyWithin(0,s,t),t-=s,s=0)},flush:n=>{t>0&&n.enqueue(e.subarray(0,t))}})}}class P extends TransformStream{constructor(e){super({transform:(t,s)=>{e.parse(t,s)},flush:t=>{e.flush(t)}})}}class U extends TransformStream{constructor(e){super({start:t=>{if(e!=null&&e.aborted){t.error(new DOMException("Operation aborted","AbortError"));return}e==null||e.addEventListener("abort",()=>{t.error(new DOMException("Operation aborted","AbortError"))},{once:!0})}})}}async function q(r,e={}){const{stream:t=!1,...s}=e,n=await M(r,s);let c=!1;const o=()=>{if(c)throw new Error("Response body has already been consumed.");return c=!0,n};return{headers:n.headers,ok:n.ok,status:n.status,statusText:n.statusText,url:n.url,get body(){return o().body},json:()=>o().json(),text:()=>o().text(),blob:()=>o().blob(),arrayBuffer:()=>o().arrayBuffer(),formData:()=>o().formData(),async*[Symbol.asyncIterator](){if(!t)throw new Error("Cannot iterate on this response. To enable streaming iteration, set the `stream: true` option in your stretto call.");const f=o().body;if(!f)return;const h=f.pipeThrough(new U(s.signal)).pipeThrough(new j).pipeThrough(new P(new N)).getReader();try{for(;;){const{done:d,value:p}=await h.read();if(d)break;yield p}}finally{h.releaseLock()}}}}return q}));
