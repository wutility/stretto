(function(f,u){typeof exports=="object"&&typeof module<"u"?u(exports):typeof define=="function"&&define.amd?define(["exports"],u):(f=typeof globalThis<"u"?globalThis:f||self,u(f.stretto={}))})(this,(function(f){"use strict";var Z=Object.defineProperty;var z=(f,u,m)=>u in f?Z(f,u,{enumerable:!0,configurable:!0,writable:!0,value:m}):f[u]=m;var h=(f,u,m)=>z(f,typeof u!="symbol"?u+"":u,m);const S=new TextDecoder,O=new TextEncoder,B=O.encode("data:"),I=O.encode("event:"),v=O.encode("id:"),M=(r,e)=>new Promise((t,a)=>{if(e!=null&&e.aborted)return a(new DOMException("Operation aborted","AbortError"));const o=setTimeout(()=>{s(),t()},r),i=()=>{s(),a((e==null?void 0:e.reason)??new DOMException("Operation aborted","AbortError"))},s=()=>{clearTimeout(o),e==null||e.removeEventListener("abort",i)};e==null||e.addEventListener("abort",i,{once:!0})}),F=r=>typeof r=="object"&&r!==null&&!Array.isArray(r)&&(Object.getPrototypeOf(r)===null||Object.getPrototypeOf(r)===Object.prototype),T=(r,e)=>{if(e.length>r.length)return!1;for(let t=0;t<e.length;t++)if(r[t]!==e[t])return!1;return!0},P=r=>r[0]===32?r.subarray(1):r,A=r=>{try{return JSON.parse(r)}catch{return null}},C=r=>r.status>=500&&r.status<600,N=100,U=5e3,q=2,R=.5,J=r=>{const e=N*Math.pow(q,r-1);return Math.min(U,e)*(1-R+Math.random()*R)};async function j(r,e){const{body:t,headers:a={},retries:o=3,timeout:i=3e4,backoffStrategy:s=J,retryOn:l=C,signal:n,...D}=e;let p,E;for(let d=0;d<o+1;d++){if(n!=null&&n.aborted)throw new DOMException("Operation aborted","AbortError");const c=new AbortController,b=c.signal,y=()=>c.abort(n==null?void 0:n.reason);n==null||n.addEventListener("abort",y,{once:!0});const K=setTimeout(()=>c.abort(new DOMException("Request timed out","TimeoutError")),i);try{d>0&&await M(s(d),b);const w=new Headers(a),L={...D,headers:w,signal:b};F(t)?(w.set("Content-Type","application/json"),L.body=JSON.stringify(t)):L.body=t;const x=await fetch(r,L);if(E=x,d<o&&l(x,d))continue;return x}catch(w){if(p=w,n!=null&&n.aborted)throw new DOMException("Operation aborted","AbortError");if(b.aborted)throw c.signal.reason instanceof DOMException?c.signal.reason:p}finally{clearTimeout(K),n==null||n.removeEventListener("abort",y)}}throw E?new Error(`Request failed after all retry attempts. Last response status: ${E.status}`):p??new Error("Request failed after all retry attempts.")}class _{constructor(e={}){h(this,"sseBuffer",[]);h(this,"strict");h(this,"endOfStreamSentinel");this.strict=e.strict??!0,this.endOfStreamSentinel=e.endOfStreamSentinel??"[DONE]"}parse(e,t){if(e.length===0){this.flushSseBuffer(t);return}if(T(e,B)){const i=S.decode(P(e.subarray(B.length)));this.sseBuffer.push(i);return}if(T(e,I)||T(e,v)||e[0]===58)return;this.flushSseBuffer(t);const a=S.decode(e),o=A(a);if(o!==null)t.enqueue(o);else if(this.strict)throw new TypeError(`Invalid JSON received in stream: "${a}"`)}flush(e){this.flushSseBuffer(e)}flushSseBuffer(e){if(this.sseBuffer.length===0)return;let t;if(this.sseBuffer.length===1?t=this.sseBuffer[0]:t=this.sseBuffer.join(`
`),t.trim()===this.endOfStreamSentinel)return;this.sseBuffer.length=0;const a=A(t);if(a!==null)e.enqueue(a);else if(this.strict)throw new TypeError(`Invalid JSON received in SSE data buffer: "${t}"`)}reset(){this.sseBuffer.length=0}}class X{constructor(e={}){h(this,"strict");this.strict=e.strict??!0}parse(e,t){if(e.length===0)return;const a=S.decode(e,{stream:!0}),o=A(a);if(o!==null)t.enqueue(o);else if(this.strict)throw new TypeError("Invalid JSON received in stream")}flush(e){}}class $ extends TransformStream{constructor(){super({transform:(t,a)=>{if(t.length===0)return;const o=this.leftover.length>0?this.mergeBuffers(this.leftover,t):t;let i=0;for(let s=0;s<o.length;s++)if(o[s]===10){const l=s>0&&o[s-1]===13?s-1:s;a.enqueue(o.subarray(i,l)),i=s+1}this.leftover=i<o.length?o.subarray(i):new Uint8Array(0)},flush:t=>{this.leftover.length>0&&t.enqueue(this.leftover)}});h(this,"leftover",new Uint8Array(0));h(this,"MAX_BUFFER_SIZE",1e6)}mergeBuffers(t,a){if(t.length+a.length>this.MAX_BUFFER_SIZE)throw new Error("LineTransformer buffer exceeded maximum size");const o=new Uint8Array(t.length+a.length);return o.set(t),o.set(a,t.length),o}}class k extends TransformStream{constructor(e){super({transform:(t,a)=>{e.parse(t,a)},flush:t=>{e.flush(t)}})}}class g extends TransformStream{constructor(e){super({start(t){if(e!=null&&e.aborted){t.error(e.reason??new DOMException("Operation aborted","AbortError"));return}e==null||e.addEventListener("abort",()=>t.error(e.reason??new DOMException("Operation aborted","AbortError")),{once:!0})}})}}async function H(r,e={}){const{stream:t=!1,parser:a,strictJson:o=!0,...i}=e,s=await j(r,i);if(!t&&!s.ok)throw new Error(`Request failed: ${s.status} ${s.statusText}`);let l=!1;const n=()=>{if(l)throw new Error("Response body has already been consumed.");return l=!0,s};return{headers:s.headers,ok:s.ok,status:s.status,statusText:s.statusText,url:s.url,get body(){return n().body},json:()=>n().json(),text:()=>n().text(),blob:()=>n().blob(),arrayBuffer:()=>n().arrayBuffer(),formData:()=>n().formData(),async*[Symbol.asyncIterator](){if(!t)throw new Error("Streaming not enabled. Use { stream: true } in options.");const p=n().body;if(!p)return;const E=a??new _({strict:o}),c=p.pipeThrough(new g(i.signal)).pipeThrough(new $).pipeThrough(new k(E)).getReader();try{for(;;){const{done:b,value:y}=await c.read();if(b)break;y!==void 0&&(yield y)}}finally{c.releaseLock()}}}}f.JsonLinesParser=X,f.SseParser=_,f.default=H,Object.defineProperties(f,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
