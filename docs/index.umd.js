(function(d,i){typeof exports=="object"&&typeof module<"u"?module.exports=i():typeof define=="function"&&define.amd?define(i):(d=typeof globalThis<"u"?globalThis:d||self,d.stretto=i())})(this,(function(){"use strict";var H=Object.defineProperty;var X=(d,i,b)=>i in d?H(d,i,{enumerable:!0,configurable:!0,writable:!0,value:b}):d[i]=b;var x=(d,i,b)=>X(d,typeof i!="symbol"?i+"":i,b);const B=new TextDecoder,S=new TextEncoder,L=S.encode("data:"),P=S.encode("event:"),I=S.encode("id:"),j=r=>new Promise(t=>setTimeout(t,r)),_=r=>typeof r=="object"&&r!==null&&!Array.isArray(r)&&(Object.getPrototypeOf(r)===null||Object.getPrototypeOf(r)===Object.prototype),F=r=>r.status>=500&&r.status<600,U=r=>Math.min(5e3,100*Math.pow(2,r-1))*(.5+Math.random()*.5);async function q(r,t){var y,h,m,p;const{body:e,headers:n={},retries:s=3,timeout:o=3e4,backoffStrategy:a=U,retryOn:u=F,signal:f,...T}=t;let w;for(let l=0;l<=s;l++){const E=new AbortController,g=E.signal,C=()=>E.abort((f==null?void 0:f.reason)??void 0);(y=f==null?void 0:f.addEventListener)==null||y.call(f,"abort",C);const D=o>0?setTimeout(()=>E.abort(new DOMException("Request timed out","TimeoutError")),o):void 0;try{l>0&&await j(a(l));const c=new Headers(n),A={...T,headers:c,signal:g};_(e)?(c.has("Content-Type")||c.set("Content-Type","application/json"),A.body=JSON.stringify(e)):e!==void 0&&(A.body=e);const R=await fetch(r,A);if(l<s&&u(R.clone())){await((m=(h=R.body)==null?void 0:h.cancel)==null?void 0:m.call(h));continue}return R}catch(c){if(w=c,g.aborted||(c==null?void 0:c.name)==="AbortError"||(c==null?void 0:c.name)==="TimeoutError")throw w}finally{D!==void 0&&clearTimeout(D),(p=f==null?void 0:f.removeEventListener)==null||p.call(f,"abort",C)}}throw new Error("Request failed after all retry attempts.",{cause:w})}const v=r=>{try{return JSON.parse(r)}catch{return null}},O=(r,t)=>{if(t.length>r.length)return!1;for(let e=0;e<t.length;e++)if(r[e]!==t[e])return!1;return!0};class M{constructor(){x(this,"sseBuffer",[])}parse(t,e){if(!t||t.length===0){this.flushSseBuffer(e);return}if(O(t,L)){let o=L.length;t.length>o&&t[o]===32&&o++;const a=B.decode(t.subarray(o));this.sseBuffer.push(a);return}if(O(t,P)||O(t,I)||t[0]===58)return;this.flushSseBuffer(e);const n=B.decode(t),s=v(n)??n;e.enqueue(s)}flush(t){this.flushSseBuffer(t)}flushSseBuffer(t){if(this.sseBuffer.length===0)return;const e=this.sseBuffer.join(`
`);this.sseBuffer.length=0;const n=v(e)??e;t.enqueue(n)}}class N extends TransformStream{constructor(){super({transform:(e,n)=>{if(e.length===0)return;const s=this.leftover.length>0?this.mergeBuffers(this.leftover,e):e;let o=0;for(let a=0;a<s.length;a++)if(s[a]===10){const u=a>0&&s[a-1]===13?a-1:a;n.enqueue(s.subarray(o,u)),o=a+1}this.leftover=o<s.length?s.subarray(o):new Uint8Array(0)},flush:e=>{this.leftover.length>0&&e.enqueue(this.leftover)}});x(this,"leftover",new Uint8Array(0))}mergeBuffers(e,n){const s=new Uint8Array(e.length+n.length);return s.set(e),s.set(n,e.length),s}}class J extends TransformStream{constructor(t){super({transform:(e,n)=>{t.parse(e,n)},flush:e=>{t.flush(e)}})}}async function k(r,t={}){const{stream:e=!1,parser:n=new M,...s}=t,o=await q(r,s);let a=!1;const u=()=>{if(a)throw new Error("Response body has already been consumed.");return a=!0,o};return{headers:o.headers,ok:o.ok,status:o.status,statusText:o.statusText,url:o.url,get body(){return u().body},json:()=>u().json(),text:()=>u().text(),blob:()=>u().blob(),arrayBuffer:()=>u().arrayBuffer(),formData:()=>u().formData(),async*[Symbol.asyncIterator](){var m,p,l;if(!e)throw new Error("Cannot iterate on this response. To enable streaming iteration, set `stream: true` in your stretto call.");const T=u().body;if(!T)return;if((m=s.signal)!=null&&m.aborted)throw new DOMException("Operation aborted","AbortError");const y=T.pipeThrough(new N).pipeThrough(new J(n)).getReader(),h=()=>{y.cancel(new DOMException("Operation aborted","AbortError")).catch(()=>{})};(p=s.signal)==null||p.addEventListener("abort",h);try{for(;;){const{done:E,value:g}=await y.read();if(E)break;yield g}}finally{(l=s.signal)==null||l.removeEventListener("abort",h),y.releaseLock()}}}}return k}));
