(function(h,m){typeof exports=="object"&&typeof module<"u"?module.exports=m():typeof define=="function"&&define.amd?define(m):(h=typeof globalThis<"u"?globalThis:h||self,h.stretto=m())})(this,(function(){"use strict";const T=new TextDecoder,y=new TextEncoder,g=y.encode("data:"),R=y.encode("event:"),x=y.encode("id:"),_=r=>new Promise(e=>setTimeout(e,r)),A=r=>typeof r=="object"&&r!==null&&!Array.isArray(r)&&(Object.getPrototypeOf(r)===null||Object.getPrototypeOf(r)===Object.prototype),B=r=>r.status>=500&&r.status<600,D=r=>Math.min(5e3,100*Math.pow(2,r-1))*(.5+Math.random()*.5);function I(r){const e=r.headers.get("content-encoding");if(!e||!r.body||typeof DecompressionStream>"u")return r;const t=r.body.pipeThrough(new DecompressionStream(e));return new Response(t,r)}async function F(r,e){const{body:t,headers:o={},retries:s=3,timeout:a=3e4,backoffStrategy:n=D,retryOn:i=B,signal:c,...S}=e;let u;for(let f=0;f<=s;f++){const d=new AbortController,L=d.signal,O=()=>d.abort(c?.reason);c?.addEventListener("abort",O,{once:!0});const q=a>0?setTimeout(()=>d.abort(new DOMException("Request timed out","TimeoutError")),a):0;try{f>0&&await _(n(f));const l=new Headers(o),E={...S,headers:l,signal:L};A(t)?(l.has("Content-Type")||l.set("Content-Type","application/json"),E.body=JSON.stringify(t)):E.body=t;const p=await fetch(r,E);if(p.ok)return I(p);if(f<s&&i(p.clone()))continue;return p}catch(l){if(u=l,L.aborted)throw u}finally{clearTimeout(q),c?.removeEventListener("abort",O)}}throw u??new Error("Request failed after all retry attempts.")}const w=r=>{try{return JSON.parse(r)}catch{return null}},b=(r,e)=>{if(e.length>r.length)return!1;for(let t=0;t<e.length;t++)if(r[t]!==e[t])return!1;return!0},M=r=>r[0]===32?r.subarray(1):r;class C{sseBuffer=[];parse(e,t){if(e.length===0){this.flushSseBuffer(t);return}if(b(e,g)){const a=T.decode(M(e.subarray(g.length)));this.sseBuffer.push(a);return}if(b(e,R)||b(e,x)||e[0]===58)return;this.flushSseBuffer(t);const o=T.decode(e),s=w(o)??o;t.enqueue(s)}flush(e){this.flushSseBuffer(e)}flushSseBuffer(e){if(this.sseBuffer.length===0)return;const t=this.sseBuffer.join(`
`);this.sseBuffer.length=0;const o=w(t)??t;e.enqueue(o)}}class N extends TransformStream{constructor(){let e=new Uint8Array(65536),t=0,o=0;super({transform:(s,a)=>{if(t+s.length>e.length){if(t+s.length>1048576)throw new Error("Line exceeds maximum length of 1048576 bytes");const n=Math.max(e.length*2,t+s.length),i=new Uint8Array(n);i.set(e.subarray(0,t)),e=i}e.set(s,t),t+=s.length;for(let n=o;n<t;n++)if(e[n]===10){const i=n>0&&e[n-1]===13?n-1:n;a.enqueue(e.subarray(o,i)),o=n+1}o>0&&(e.copyWithin(0,o,t),t-=o,o=0)},flush:s=>{t>0&&s.enqueue(e.subarray(0,t))}})}}class j extends TransformStream{constructor(e){super({transform:(t,o)=>{e.parse(t,o)},flush:t=>{e.flush(t)}})}}class P extends TransformStream{constructor(e){super({start:t=>{if(e?.aborted){t.error(new DOMException("Operation aborted","AbortError"));return}e?.addEventListener("abort",()=>{t.error(new DOMException("Operation aborted","AbortError"))},{once:!0})}})}}async function U(r,e={}){const{stream:t=!1,...o}=e,s=await F(r,o);let a=!1;const n=()=>{if(a)throw new Error("Response body has already been consumed.");return a=!0,s};return{headers:s.headers,ok:s.ok,status:s.status,statusText:s.statusText,url:s.url,get body(){return n().body},json:()=>n().json(),text:()=>n().text(),blob:()=>n().blob(),arrayBuffer:()=>n().arrayBuffer(),formData:()=>n().formData(),async*[Symbol.asyncIterator](){if(!t)throw new Error("Cannot iterate on this response. To enable streaming iteration, set the `stream: true` option in your stretto call.");const c=n().body;if(!c)return;const u=c.pipeThrough(new P(o.signal)).pipeThrough(new N).pipeThrough(new j(new C)).getReader();try{for(;;){const{done:f,value:d}=await u.read();if(f)break;yield d}}finally{u.releaseLock()}}}}return U}));
