(function(i,u){typeof exports=="object"&&typeof module<"u"?u(exports):typeof define=="function"&&define.amd?define(["exports"],u):(i=typeof globalThis<"u"?globalThis:i||self,u(i.stretto={}))})(this,(function(i){"use strict";var Z=Object.defineProperty;var z=(i,u,b)=>u in i?Z(i,u,{enumerable:!0,configurable:!0,writable:!0,value:b}):i[u]=b;var h=(i,u,b)=>z(i,typeof u!="symbol"?u+"":u,b);const S=new TextDecoder,O=new TextEncoder,B=O.encode("data:"),I=O.encode("event:"),v=O.encode("id:"),M=(r,e)=>new Promise((t,s)=>{if(e!=null&&e.aborted)return s(new DOMException("Operation aborted","AbortError"));const n=setTimeout(()=>{o(),t()},r),f=()=>{o(),s((e==null?void 0:e.reason)??new DOMException("Operation aborted","AbortError"))},o=()=>{clearTimeout(n),e==null||e.removeEventListener("abort",f)};e==null||e.addEventListener("abort",f,{once:!0})}),F=r=>typeof r=="object"&&r!==null&&!Array.isArray(r)&&(Object.getPrototypeOf(r)===null||Object.getPrototypeOf(r)===Object.prototype),T=(r,e)=>{if(e.length>r.length)return!1;for(let t=0;t<e.length;t++)if(r[t]!==e[t])return!1;return!0},P=r=>r[0]===32?r.subarray(1):r,A=r=>{try{return JSON.parse(r)}catch{return null}},C=r=>r.status>=500&&r.status<600,N=100,U=5e3,j=2,R=.5,q=r=>{const e=N*Math.pow(j,r-1);return Math.min(U,e)*(1-R+Math.random()*R)};async function J(r,e){const{body:t,headers:s={},retries:n=3,timeout:f=3e4,backoffStrategy:o=q,retryOn:l=C,signal:a,...D}=e;let p,m;for(let d=0;d<n+1;d++){if(a!=null&&a.aborted)throw new DOMException("Operation aborted","AbortError");const c=new AbortController,E=c.signal,y=()=>c.abort(a==null?void 0:a.reason);a==null||a.addEventListener("abort",y,{once:!0});const K=f>0?setTimeout(()=>c.abort(new DOMException("Request timed out","TimeoutError")),f):0;try{d>0&&await M(o(d),E);const w=new Headers(s),L={...D,headers:w,signal:E};F(t)?(w.has("Content-Type")||w.set("Content-Type","application/json"),L.body=JSON.stringify(t)):L.body=t;const x=await fetch(r,L);if(m=x,d<n&&l(x,d))continue;return x}catch(w){if(p=w,a!=null&&a.aborted)throw new DOMException("Operation aborted","AbortError");if(E.aborted)throw c.signal.reason instanceof DOMException?c.signal.reason:p}finally{clearTimeout(K),a==null||a.removeEventListener("abort",y)}}throw m?new Error(`Request failed after all retry attempts. Last response status: ${m.status}`):p??new Error("Request failed after all retry attempts.")}class _{constructor(e={}){h(this,"sseBuffer",[]);h(this,"strict");h(this,"endOfStreamSentinel");this.strict=e.strict??!0,this.endOfStreamSentinel=e.endOfStreamSentinel??"[DONE]"}parse(e,t){if(e.length===0){this.flushSseBuffer(t);return}if(T(e,B)){const f=S.decode(P(e.subarray(B.length)));this.sseBuffer.push(f);return}if(T(e,I)||T(e,v)||e[0]===58)return;this.flushSseBuffer(t);const s=S.decode(e),n=A(s);if(n!==null)t.enqueue(n);else if(this.strict)throw new TypeError(`Invalid JSON received in stream: "${s}"`)}flush(e){this.flushSseBuffer(e)}flushSseBuffer(e){if(this.sseBuffer.length===0)return;let t;if(this.sseBuffer.length===1?t=this.sseBuffer[0]:t=this.sseBuffer.join(`
`),t===this.endOfStreamSentinel)return;this.sseBuffer.length=0;const s=A(t);if(s!==null)e.enqueue(s);else if(this.strict)throw new TypeError(`Invalid JSON received in SSE data buffer: "${t}"`)}reset(){this.sseBuffer.length=0}}class X{constructor(e={}){h(this,"strict");this.strict=e.strict??!0}parse(e,t){if(e.length===0)return;const s=S.decode(e),n=A(s);if(n!==null)t.enqueue(n);else if(this.strict)throw new TypeError(`Invalid JSON received in stream: "${s}"`)}flush(e){}}class $ extends TransformStream{constructor(){super({transform:(t,s)=>{if(t.length===0)return;const n=this.leftover.length>0?this.mergeBuffers(this.leftover,t):t;let f=0;for(let o=0;o<n.length;o++)if(n[o]===10){const l=o>0&&n[o-1]===13?o-1:o;s.enqueue(n.subarray(f,l)),f=o+1}this.leftover=f<n.length?n.subarray(f):new Uint8Array(0)},flush:t=>{this.leftover.length>0&&t.enqueue(this.leftover)}});h(this,"leftover",new Uint8Array(0));h(this,"MAX_BUFFER_SIZE",1e6)}mergeBuffers(t,s){if(t.length+s.length>this.MAX_BUFFER_SIZE)throw new Error("LineTransformer buffer exceeded maximum size");const n=new Uint8Array(t.length+s.length);return n.set(t),n.set(s,t.length),n}}class g extends TransformStream{constructor(e){super({transform:(t,s)=>{e.parse(t,s)},flush:t=>{e.flush(t)}})}}class k extends TransformStream{constructor(e){super({start:t=>{if(e!=null&&e.aborted){t.error(new DOMException("Operation aborted","AbortError"));return}e==null||e.addEventListener("abort",()=>{t.error(new DOMException("Operation aborted","AbortError"))},{once:!0})}})}}async function H(r,e={}){const{stream:t=!1,parser:s,strictJson:n=!0,...f}=e,o=await J(r,f);if(!t&&!o.ok)throw Object.assign(new Error(`Request failed: ${o.status} ${o.statusText}`),{response:o.clone()});let l=!1;const a=()=>{if(l)throw new Error("Response body has already been consumed.");return l=!0,o};return{headers:o.headers,ok:o.ok,status:o.status,statusText:o.statusText,url:o.url,get body(){return a().body},json:()=>a().json(),text:()=>a().text(),blob:()=>a().blob(),arrayBuffer:()=>a().arrayBuffer(),formData:()=>a().formData(),async*[Symbol.asyncIterator](){if(!t)throw new Error("Streaming not enabled. Use { stream: true } in options.");const p=a().body;if(!p)return;const m=s??new _({strict:n}),c=p.pipeThrough(new k(f.signal)).pipeThrough(new $).pipeThrough(new g(m)).getReader();try{for(;;){const{done:E,value:y}=await c.read();if(E)break;y!==void 0&&(yield y)}}finally{c.releaseLock()}}}}i.JsonLinesParser=X,i.SseParser=_,i.default=H,Object.defineProperties(i,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
