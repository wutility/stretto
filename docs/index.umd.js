(function(f,a){typeof exports=="object"&&typeof module<"u"?a(exports):typeof define=="function"&&define.amd?define(["exports"],a):(f=typeof globalThis<"u"?globalThis:f||self,a(f.stretto={}))})(this,(function(f){"use strict";var W=Object.defineProperty;var k=(f,a,E)=>a in f?W(f,a,{enumerable:!0,configurable:!0,writable:!0,value:E}):f[a]=E;var w=(f,a,E)=>k(f,typeof a!="symbol"?a+"":a,E);const M=new TextDecoder,O=new TextEncoder,R=O.encode("data:"),P=O.encode("event:"),g=O.encode("id:"),C=100,v=5e3,F=2,B=.5,q=(r,t)=>new Promise((e,n)=>{if(t!=null&&t.aborted)return n(new DOMException("Operation aborted","AbortError"));const o=setTimeout(e,r),s=()=>{clearTimeout(o),n(new DOMException("Operation aborted","AbortError"))};t==null||t.addEventListener("abort",s,{once:!0}),Promise.resolve().finally(()=>t==null?void 0:t.removeEventListener("abort",s))}),D=r=>typeof r=="object"&&r!==null&&!Array.isArray(r)&&(Object.getPrototypeOf(r)===null||Object.getPrototypeOf(r)===Object.prototype),L=(r,t)=>{if(t.length>r.length)return!1;for(let e=0;e<t.length;e++)if(r[e]!==t[e])return!1;return!0},N=r=>r[0]===32?r.subarray(1):r,I=r=>{try{return JSON.parse(r)}catch{return null}},j=r=>r.status>=500&&r.status<600,U=r=>{const t=C*Math.pow(F,r-1);return Math.min(v,t)*(1-B+Math.random()*B)};async function J(r,t){var u,d,m,c,T;const{retries:e=3,timeout:n=3e4,...o}=t,{backoffStrategy:s=U,retryOn:i=j}=o;let b;const l=new Headers(o.headers);D(o.body)&&!l.has("Content-Type")&&l.set("Content-Type","application/json");for(let y=0;y<e+1;y++){if((u=t.signal)!=null&&u.aborted)throw new DOMException("Operation aborted","AbortError");y>0&&await q(s(y),t.signal);const h=new AbortController,S=()=>{var p;return h.abort((p=t.signal)==null?void 0:p.reason)};(d=t.signal)==null||d.addEventListener("abort",S,{once:!0});const A=n>0?setTimeout(()=>h.abort(new DOMException("Request timed out","TimeoutError")),n):0;try{const p={...o,headers:l,body:D(o.body)?JSON.stringify(o.body):o.body,signal:h.signal},x=await fetch(r,p);if(y<e&&i(x,t)){await((m=x.body)==null?void 0:m.cancel());continue}return x}catch(p){if(b=p,(c=t.signal)!=null&&c.aborted||h.signal.reason instanceof DOMException)throw b}finally{clearTimeout(A),(T=t.signal)==null||T.removeEventListener("abort",S)}}throw b??new Error("Request failed after all retry attempts.")}class X{constructor(t={}){w(this,"strict");this.strict=t.strict??!0}}class _ extends X{constructor(){super(...arguments);w(this,"sseBuffer",[])}reset(){throw new Error("Method not implemented.")}parse(e,n){if(e.length===0){this.flushSseBuffer(n);return}if(L(e,R)){const i=M.decode(N(e.subarray(R.length)));this.sseBuffer.push(i);return}if(L(e,P)||L(e,g)||e[0]===58)return;this.flushSseBuffer(n);const o=M.decode(e),s=I(o);if(s!==null)n.enqueue(s);else if(this.strict)throw new TypeError(`Invalid JSON received in stream: "${o}"`)}flush(e){this.flushSseBuffer(e)}flushSseBuffer(e){if(this.sseBuffer.length===0)return;const n=this.sseBuffer.join(`
`);this.sseBuffer.length=0;const o=I(n);if(o!==null)e.enqueue(o);else if(this.strict)throw new TypeError(`Invalid JSON received in SSE data buffer: "${n}"`)}}class $ extends TransformStream{constructor(){super({transform:(e,n)=>{e.length!==0&&(this.ensureCapacity(e.length),this.buffer.set(e,this.bufferLength),this.bufferLength+=e.length,this.processLines(n))},flush:e=>{this.bufferLength>0&&e.enqueue(this.buffer.subarray(0,this.bufferLength))}});w(this,"buffer",new Uint8Array(8192));w(this,"bufferLength",0)}ensureCapacity(e){const n=this.bufferLength+e;if(n>this.buffer.length){const o=Math.max(n,this.buffer.length*2),s=new Uint8Array(o);s.set(this.buffer.subarray(0,this.bufferLength)),this.buffer=s}}processLines(e){let n=0;for(let o=0;o<this.bufferLength;o++)if(this.buffer[o]===10){const s=o>0&&this.buffer[o-1]===13?o-1:o;e.enqueue(this.buffer.subarray(n,s)),n=o+1}n>0&&(this.buffer.copyWithin(0,n,this.bufferLength),this.bufferLength-=n)}}class H extends TransformStream{constructor(t){super({transform:(e,n)=>t.parse(e,n),flush:e=>t.flush(e)})}}class z extends TransformStream{constructor(t){let e;super({start:n=>{if(t!=null&&t.aborted){n.error(new DOMException("Operation aborted","AbortError"));return}e=()=>{n.error(new DOMException("Operation aborted","AbortError")),t==null||t.removeEventListener("abort",e)},t==null||t.addEventListener("abort",e,{once:!0})}})}}async function K(r,t={}){const{stream:e=!1,parser:n,strictJson:o=!0,...s}=t,i=await J(r,s);if(!e&&!i.ok){const u=await i.text().catch(()=>"");throw new Error(`Request failed: ${i.status} ${i.statusText}. Body: ${u}`)}let b=!1;const l=()=>{if(b)throw new Error("Response body has already been consumed.");b=!0};return new Proxy(i,{get(u,d,m){if(d===Symbol.asyncIterator)return async function*(){if(!e)throw new Error("Streaming not enabled. Use { stream: true } in options.");l();const c=u.body;if(!c)return;const T=n??new _({strict:o}),h=c.pipeThrough(new z(s.signal)).pipeThrough(new $).pipeThrough(new H(T)).getReader();try{for(;;){const{done:S,value:A}=await h.read();if(S)break;yield A}}finally{h.releaseLock()}};if(["body","json","text","blob","arrayBuffer","formData"].includes(d)){l();const c=Reflect.get(u,d,m);return typeof c=="function"?c.bind(u):c}return Reflect.get(u,d,m)}})}f.SseParser=_,f.default=K,Object.defineProperties(f,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
