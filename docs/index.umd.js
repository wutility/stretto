(function(c,u){typeof exports=="object"&&typeof module<"u"?u(exports):typeof define=="function"&&define.amd?define(["exports"],u):(c=typeof globalThis<"u"?globalThis:c||self,u(c.stretto={}))})(this,(function(c){"use strict";var k=Object.defineProperty;var ee=(c,u,E)=>u in c?k(c,u,{enumerable:!0,configurable:!0,writable:!0,value:E}):c[u]=E;var h=(c,u,E)=>ee(c,typeof u!="symbol"?u+"":u,E);const u="Body has already been consumed.",E=Symbol.asyncIterator;function S(n,e,t){if(!n.body)return n;let r=!1;const i=new Map,s=e.length>0?e.reduce((f,a)=>f.pipeThrough(a),n.body):n.body,o={get(f,a){if(a===E)return async function*(){if(r)throw new Error(u);r=!0;const L=s.getReader(),m=()=>L.cancel(t==null?void 0:t.reason).catch(()=>{});t==null||t.addEventListener("abort",m);try{for(;;){const{done:b,value:P}=await L.read();if(b)return;yield P}}finally{t==null||t.removeEventListener("abort",m),L.releaseLock()}};const d=Reflect.get(f,a);return typeof d=="function"?(i.has(a)||i.set(a,d.bind(f)),i.get(a)):d}};return new Proxy(n,o)}const C=100,v=5e3,T="AbortError",z="TimeoutError",U="Connection timeout",I=new Set([408,429,500,502,503,504]),N=n=>new Promise(e=>setTimeout(e,n)),F=n=>{const t=(C<<n-1)*Math.random();return Math.min(v,t)},M=(n,e)=>(console.warn(n),n instanceof DOMException&&n.name===T?!1:e&&I.has(e.status)?!0:!(n instanceof DOMException)),j=(n,e)=>{const t=new AbortController;if(e!=null&&e.aborted)return t.abort(e.reason),{signal:t.signal,cleanup:()=>{}};let r;const i=()=>{r&&clearTimeout(r),t.abort(e==null?void 0:e.reason)};n>0&&n!==1/0&&(r=setTimeout(()=>{t.abort(new DOMException(U,z))},n)),e&&e.addEventListener("abort",i,{once:!0});const s=()=>{r&&clearTimeout(r),e==null||e.removeEventListener("abort",i)};return{signal:t.signal,timeoutId:r,cleanup:s}},J=3,H=3e4,Y="Request aborted by user";async function q(n,e={}){var L;const{retries:t=J,timeout:r=H,backoffStrategy:i=F,retryOn:s=M,stream:o=!1,transformers:f=[],...a}=e,d=a.signal;for(let m=0;m<=t;m++){if(d!=null&&d.aborted)throw d.reason??new DOMException(Y,T);const{signal:b,cleanup:P}=j(r,d);a.signal=b;try{m>0&&await N(i(m));const l=await fetch(n,a);if(!l.ok){if(await((L=l.body)==null?void 0:L.cancel()),m<t&&s(void 0,l))continue;throw new Error(`HTTP Error: ${l.status} ${l.statusText}`)}return o?S(l,f,d):l}catch(l){if(m<t&&s(l,void 0))continue;throw l}finally{P()}}throw new Error("Stretto retry loop exited unexpectedly.")}const V=10,G=13,g=new Uint8Array([100,97,116,97,58,32]),K=new Uint8Array([91,68,79,78,69,93]),w=new TextDecoder,B=new TextEncoder;class $ extends TransformStream{constructor(e){super(new W(e))}}class W{constructor(e={}){h(this,"dataPrefix");h(this,"donePrefix");h(this,"parseData");h(this,"maxBufferSize");h(this,"buffer");h(this,"writePos",0);h(this,"readPos",0);h(this,"occupied",0);this.parseData=e.parseData??!0,this.maxBufferSize=e.maxBufferSize||8192,this.buffer=new Uint8Array(this.maxBufferSize),this.dataPrefix=e.dataPrefix?B.encode(e.dataPrefix):g,this.donePrefix=e.donePrefix?B.encode(e.donePrefix):K}transform(e,t){if(e.length!==0){if(e.length===this.dataPrefix.length&&this.bytesEqual(e,this.dataPrefix)){this.ensureCapacity(e.length)&&this.writeChunk(e);return}if(this.occupied+e.length>this.maxBufferSize){this.reset(),console.warn("Buffer overflow: Discarding data to prevent overflow");return}this.writeChunk(e),this.processBuffer(t)}}flush(e){this.occupied>0&&this.processLine(e,this.readPos,this.occupied),this.reset()}writeChunk(e){const t=this.maxBufferSize-this.writePos;e.length<=t?this.buffer.set(e,this.writePos):(this.buffer.set(e.subarray(0,t),this.writePos),this.buffer.set(e.subarray(t),0)),this.writePos=(this.writePos+e.length)%this.maxBufferSize,this.occupied+=e.length}processBuffer(e){for(;this.occupied>0;){const t=this.findByte(V);if(t===-1){this.compactBuffer();break}let r=t-this.readPos;r>0&&this.buffer[(this.readPos+r-1)%this.maxBufferSize]===G&&r--,r>0&&this.processLine(e,this.readPos,r);const i=t-this.readPos+1;this.readPos=(this.readPos+i)%this.maxBufferSize,this.occupied-=i}}processLine(e,t,r){if(r<this.dataPrefix.length||!this.matchPrefix(this.dataPrefix,t))return;const i=(t+this.dataPrefix.length)%this.maxBufferSize,s=r-this.dataPrefix.length;if(s===0)return;if(s===this.donePrefix.length&&this.matchPrefix(this.donePrefix,i)){e.terminate(),this.reset();return}const o=this.decodeRange(i,s);try{e.enqueue(this.parseData?JSON.parse(o):o)}catch{console.warn("Failed to parse JSON: "+o)}}findByte(e){let t=this.readPos;const r=this.readPos+this.occupied;for(;t<r;){if(this.buffer[t%this.maxBufferSize]===e)return t;t++}return-1}bytesEqual(e,t){if(e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(e[r]!==t[r])return!1;return!0}matchPrefix(e,t){if(e.length===6&&e===g){const r=t%this.maxBufferSize,i=(t+1)%this.maxBufferSize,s=(t+2)%this.maxBufferSize,o=(t+3)%this.maxBufferSize,f=(t+4)%this.maxBufferSize,a=(t+5)%this.maxBufferSize;return this.buffer[r]===100&&this.buffer[i]===97&&this.buffer[s]===116&&this.buffer[o]===97&&this.buffer[f]===58&&this.buffer[a]===32}for(let r=0;r<e.length;r++)if(e[r]!==this.buffer[(t+r)%this.maxBufferSize])return!1;return!0}decodeRange(e,t){const r=(e+t)%this.maxBufferSize;if(r>e||r===0)return w.decode(this.buffer.subarray(e,e+t));const i=this.buffer.subarray(e),s=this.buffer.subarray(0,r),o=new Uint8Array(i.length+s.length);return o.set(i),o.set(s,i.length),w.decode(o)}compactBuffer(){if(this.readPos===0)return;const e=this.occupied;if(e===0){this.readPos=0,this.writePos=0;return}this.buffer.copyWithin(0,this.readPos,this.readPos+e),this.readPos=0,this.writePos=e}ensureCapacity(e){return this.occupied+e<=this.maxBufferSize?!0:(this.compactBuffer(),this.occupied+e<=this.maxBufferSize)}reset(){this.readPos=0,this.writePos=0,this.occupied=0}}const X=10,R=13,A=58,Q=32,D=new Uint8Array([101,118,101,110,116]),O=new Uint8Array([100,97,116,97]),_=new Uint8Array([105,100]),p=new TextDecoder;class Z extends TransformStream{constructor(e){super(new y(e))}}const x=class x{constructor(e={}){h(this,"parseData");h(this,"metadata");h(this,"maxLineLength");h(this,"partialBuffer",null);h(this,"partialLength",0);h(this,"currentEvent",{});h(this,"dataLines",[]);this.parseData=e.parseData??!1,this.metadata=e.metadata??!1,this.maxLineLength=e.maxLineLength||16384,this.partialBuffer=new Uint8Array(this.maxLineLength)}transform(e,t){if(e.length===0)return;let r=0;if(this.partialLength>0){const i=this.partialLength+e.length;if(i>this.maxLineLength){this.partialLength=0,t.error(new Error("Line length exceeds maxLineLength"));return}if(e.length>this.maxLineLength-this.partialLength){this.partialLength=0,t.error(new Error("Chunk size exceeds remaining partial buffer space"));return}this.partialBuffer.set(e,this.partialLength),e=this.partialBuffer.subarray(0,i),r=this.partialLength,this.partialLength=0}for(;r<e.length;){const i=e.indexOf(X,r);if(i===-1){const o=e.length-r;if(this.partialLength+o>this.maxLineLength){this.partialLength=0,t.error(new Error("Line length exceeds maxLineLength"));return}this.partialBuffer.set(e.subarray(r),this.partialLength),this.partialLength+=o;break}let s=i-r;s>0&&e[i-1]===R&&s--,s>0?this.processLine(e,r,s):this.dispatchEvent(t),r=i+1}}flush(e){if(this.partialLength>0){let t=this.partialLength;t>0&&this.partialBuffer[t-1]===R&&t--,t>0&&this.processLine(this.partialBuffer,0,t),this.dispatchEvent(e)}this.partialLength=0,this.partialBuffer=null,this.dataLines=[],this.currentEvent={}}processLine(e,t,r){if(e[t]===A)return;const i=e.indexOf(A,t);let s=t,o=i===-1?r:i-t,f=i===-1?t+r:i+1,a=i===-1?0:r-(i-t+1);if(a>0&&e[f]===Q&&(f++,a--),this.matchField(e,s,o,D))this.currentEvent.type=a>0?p.decode(e.subarray(f,f+a)):x.DEFAULT_EVENT_TYPE;else if(this.matchField(e,s,o,O)){if(a>0){const d=p.decode(e.subarray(f,f+a));this.dataLines.push(d)}}else this.matchField(e,s,o,_)&&a>0&&e.indexOf(0,f)===-1&&(this.currentEvent.lastEventId=p.decode(e.subarray(f,f+a)))}dispatchEvent(e){if(this.dataLines.length===0){this.dataLines=[],this.currentEvent={};return}const t=this.dataLines.join(`
`);let r=t;if(this.parseData)try{r=JSON.parse(t)}catch{console.warn("Failed to parse JSON: "+t)}const i=this.metadata?{data:r,type:this.currentEvent.type??x.DEFAULT_EVENT_TYPE,lastEventId:this.currentEvent.lastEventId??""}:r;e.enqueue(i),this.dataLines=[],this.currentEvent={}}matchField(e,t,r,i){if(r!==i.length)return!1;if(i.length===4&&i[0]===O[0])return e[t]===100&&e[t+1]===97&&e[t+2]===116&&e[t+3]===97;if(i.length===5&&i[0]===D[0])return e[t]===101&&e[t+1]===118&&e[t+2]===101&&e[t+3]===110&&e[t+4]===116;if(i.length===2&&i[0]===_[0])return e[t]===105&&e[t+1]===100;for(let s=0;s<i.length;s++)if(i[s]!==e[t+s])return!1;return!0}};h(x,"DEFAULT_EVENT_TYPE","message");let y=x;c.JSONStreamTransformer=$,c.SSEStreamTransformer=Z,c.default=q,Object.defineProperties(c,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
