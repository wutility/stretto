(function(i,c){typeof exports=="object"&&typeof module<"u"?c(exports):typeof define=="function"&&define.amd?define(["exports"],c):(i=typeof globalThis<"u"?globalThis:i||self,c(i.stretto={}))})(this,(function(i){"use strict";var Z=Object.defineProperty;var z=(i,c,m)=>c in i?Z(i,c,{enumerable:!0,configurable:!0,writable:!0,value:m}):i[c]=m;var h=(i,c,m)=>z(i,typeof c!="symbol"?c+"":c,m);const w=new TextDecoder,O=new TextEncoder,_=O.encode("data:"),I=O.encode("event:"),v=O.encode("id:"),M=(r,e)=>new Promise((t,o)=>{if(e!=null&&e.aborted)return o(new DOMException("Operation aborted","AbortError"));const s=setTimeout(()=>{a(),t()},r),f=()=>{a(),o((e==null?void 0:e.reason)??new DOMException("Operation aborted","AbortError"))},a=()=>{clearTimeout(s),e==null||e.removeEventListener("abort",f)};e==null||e.addEventListener("abort",f,{once:!0})}),F=r=>typeof r=="object"&&r!==null&&!Array.isArray(r)&&(Object.getPrototypeOf(r)===null||Object.getPrototypeOf(r)===Object.prototype),T=(r,e)=>{if(e.length>r.length)return!1;for(let t=0;t<e.length;t++)if(r[t]!==e[t])return!1;return!0},P=r=>r[0]===32?r.subarray(1):r,A=r=>{try{return JSON.parse(r)}catch{return null}},C=r=>r.status>=500&&r.status<600,N=100,U=5e3,J=2,x=.5,j=r=>{const e=N*Math.pow(J,r-1);return Math.min(U,e)*(1-x+Math.random()*x)};async function q(r,e){const{body:t,headers:o={},retries:s=3,timeout:f=3e4,backoffStrategy:a=j,retryOn:l=C,signal:n,...D}=e;let p,b;for(let d=0;d<s+1;d++){if(n!=null&&n.aborted)throw new DOMException("Operation aborted","AbortError");const u=new AbortController,E=u.signal,y=()=>u.abort(n==null?void 0:n.reason);n==null||n.addEventListener("abort",y,{once:!0});const K=f>0?setTimeout(()=>u.abort(new DOMException("Request timed out","TimeoutError")),f):0;try{d>0&&await M(a(d),E);const S=new Headers(o),L={...D,headers:S,signal:E};F(t)?(S.has("Content-Type")||S.set("Content-Type","application/json"),L.body=JSON.stringify(t)):L.body=t;const B=await fetch(r,L);if(b=B,d<s&&l(B,d))continue;return B}catch(S){if(p=S,n!=null&&n.aborted)throw new DOMException("Operation aborted","AbortError");if(E.aborted)throw u.signal.reason instanceof DOMException?u.signal.reason:p}finally{clearTimeout(K),n==null||n.removeEventListener("abort",y)}}throw b?new Error(`Request failed after all retry attempts. Last response status: ${b.status}`):p??new Error("Request failed after all retry attempts.")}class R{constructor(e={}){h(this,"sseBuffer",[]);h(this,"strict");h(this,"endOfStreamSentinel");this.strict=e.strict??!0,this.endOfStreamSentinel=e.endOfStreamSentinel??"[DONE]"}parse(e,t){if(e.length===0){this.flushSseBuffer(t);return}if(T(e,_)){const f=w.decode(P(e.subarray(_.length)));this.sseBuffer.push(f);return}if(T(e,I)||T(e,v)||e[0]===58)return;this.flushSseBuffer(t);const o=w.decode(e),s=A(o);if(s!==null)t.enqueue(s);else if(this.strict)throw new TypeError(`Invalid JSON received in stream: "${o}"`)}flush(e){this.flushSseBuffer(e)}flushSseBuffer(e){if(this.sseBuffer.length===0)return;let t;if(this.sseBuffer.length===1?t=this.sseBuffer[0]:t=this.sseBuffer.join(`
`),t===this.endOfStreamSentinel)return;this.sseBuffer.length=0;const o=A(t);if(o!==null)e.enqueue(o);else if(this.strict)throw new TypeError(`Invalid JSON received in SSE data buffer: "${t}"`)}reset(){this.sseBuffer.length=0}}class X{constructor(e={}){h(this,"strict");this.strict=e.strict??!0}parse(e,t){if(e.length===0)return;const o=w.decode(e),s=A(o);if(s!==null)t.enqueue(s);else if(this.strict)throw new TypeError(`Invalid JSON received in stream: "${o}"`)}flush(e){}}class g extends TransformStream{constructor(){super({transform:(t,o)=>{if(t.length===0)return;const s=this.leftover.length>0?this.mergeBuffers(this.leftover,t):t;let f=0;for(let a=0;a<s.length;a++)if(s[a]===10){const l=a>0&&s[a-1]===13?a-1:a;o.enqueue(s.subarray(f,l)),f=a+1}this.leftover=f<s.length?s.subarray(f):new Uint8Array(0)},flush:t=>{this.leftover.length>0&&t.enqueue(this.leftover)}});h(this,"leftover",new Uint8Array(0));h(this,"MAX_BUFFER_SIZE",1e6)}mergeBuffers(t,o){if(t.length+o.length>this.MAX_BUFFER_SIZE)throw new Error("LineTransformer buffer exceeded maximum size");const s=new Uint8Array(t.length+o.length);return s.set(t),s.set(o,t.length),s}}class $ extends TransformStream{constructor(e){super({transform:(t,o)=>{e.parse(t,o)},flush:t=>{e.flush(t)}})}}class k extends TransformStream{constructor(e){super({start:t=>{if(e!=null&&e.aborted){t.error(new DOMException("Operation aborted","AbortError"));return}e==null||e.addEventListener("abort",()=>{t.error(new DOMException("Operation aborted","AbortError"))},{once:!0})}})}}async function H(r,e={}){const{stream:t=!1,parser:o,strictJson:s=!0,...f}=e,a=await q(r,f);let l=!1;const n=()=>{if(l)throw new Error("Response body has already been consumed.");return l=!0,a};return{headers:a.headers,ok:a.ok,status:a.status,statusText:a.statusText,url:a.url,get body(){return n().body},json:()=>n().json(),text:()=>n().text(),blob:()=>n().blob(),arrayBuffer:()=>n().arrayBuffer(),formData:()=>n().formData(),async*[Symbol.asyncIterator](){if(!t)throw new Error("Streaming not enabled. Use { stream: true } in options.");const p=n().body;if(!p)return;const b=o??new R({strict:s}),u=p.pipeThrough(new k(f.signal)).pipeThrough(new g).pipeThrough(new $(b)).getReader();try{for(;;){const{done:E,value:y}=await u.read();if(E)break;y!==void 0&&(yield y)}}finally{u.releaseLock()}}}}i.JsonLinesParser=X,i.SseParser=R,i.default=H,Object.defineProperties(i,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
