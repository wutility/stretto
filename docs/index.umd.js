(function(f,a){typeof exports=="object"&&typeof module<"u"?a(exports):typeof define=="function"&&define.amd?define(["exports"],a):(f=typeof globalThis<"u"?globalThis:f||self,a(f.stretto={}))})(this,(function(f){"use strict";var X=Object.defineProperty;var W=(f,a,p)=>a in f?X(f,a,{enumerable:!0,configurable:!0,writable:!0,value:p}):f[a]=p;var o=(f,a,p)=>W(f,typeof a!="symbol"?a+"":a,p);class a extends Error{constructor(t,r){super(t);o(this,"response");this.name="HTTPError",this.response=r}}const p=i=>new Promise(e=>setTimeout(e,i)),L=100,x=5e3,D=2,O=i=>{const e=L*D**i,t=Math.min(x,e);return Math.random()*t},_=(i,e)=>{if(e){const t=e.status;if(t>=500&&t<600||[408,429,409].includes(t))return!0}return i instanceof Error?!(i instanceof DOMException&&i.name==="AbortError"):!1},g=(i,e)=>{const t=new AbortController;let r;const s=()=>t.abort(e==null?void 0:e.reason);e!=null&&e.aborted&&s(),i>0&&(r=setTimeout(()=>{t.abort(new DOMException("Connection timeout","TimeoutError"))},i)),e==null||e.addEventListener("abort",s);const n=()=>{r&&clearTimeout(r),e==null||e.removeEventListener("abort",s)};return{signal:t.signal,cleanup:n}},k=3,C=3e4,I=(i,e,t=[],r)=>{if(!e)return i;let s=!1;const n={get(c,m,h){if(m===Symbol.asyncIterator)return async function*(){if(s)throw new Error("Body has already been consumed.");const b=c.body;if(!b)return;s=!0;let d=b;for(const u of t)d=d.pipeThrough(u);const E=d.getReader(),l=()=>E.cancel(r==null?void 0:r.reason);r==null||r.addEventListener("abort",l);try{for(;;){if(r!=null&&r.aborted)throw r.reason??new DOMException("Request aborted by user","AbortError");const{done:u,value:T}=await E.read();if(u)break;yield T}}finally{r==null||r.removeEventListener("abort",l),E.releaseLock()}};const B=Reflect.get(c,m,h);return typeof B=="function"?B.bind(c):B}};return new Proxy(i,n)};async function N(i,e={}){const{retries:t=k,timeout:r=C,backoffStrategy:s=O,retryOn:n=_,stream:c=!1,transformers:m=[],signal:h,...B}=e;let b=new Error(`Request failed after ${t+1} attempts`);for(let d=0;d<=t;d++){if(h!=null&&h.aborted)throw h.reason??new DOMException("Request aborted by user","AbortError");const{signal:E,cleanup:l}=g(r,h);try{const u=await fetch(i,{...B,signal:E});if(!u.ok)throw new a(`HTTP ${u.status}: ${u.statusText}`,u);return l(),I(u,c,m,h)}catch(u){b=u;const T=u instanceof a?u.response:void 0;if(!n(u,T)||d===t)throw l(),b}l(),await p(s(d))}throw b}class v{constructor(e=8192){o(this,"buffer");o(this,"writePos",0);o(this,"readPos",0);o(this,"_occupied",0);o(this,"mask");if(e<=0)throw new RangeError("Buffer size must be positive.");const t=1<<31-Math.clz32(e-1|0);this.buffer=new Uint8Array(t),this.mask=t-1}get occupied(){return this._occupied}get capacity(){return this.buffer.length}peekByte(e){return this.buffer[this.readPos+e&this.mask]}write(e){const t=e.length;if(this._occupied+t>this.buffer.length)return!1;const r=this.writePos,s=Math.min(t,this.buffer.length-r);return this.buffer.set(e.subarray(0,s),r),t-s>0&&this.buffer.set(e.subarray(s),0),this.writePos=r+t&this.mask,this._occupied+=t,!0}getView(e,t){const r=this.readPos+e&this.mask;if(r+t<=this.buffer.length)return this.buffer.subarray(r,r+t);const s=new Uint8Array(t),n=this.buffer.length-r;return s.set(this.buffer.subarray(r)),s.set(this.buffer.subarray(0,t-n),n),s}consume(e){e<=0||(e=Math.min(e,this._occupied),this._occupied-=e,this.readPos=this.readPos+e&this.mask)}}const R=new TextDecoder,M=10,F="[DONE]",U="data: ";class H extends TransformStream{constructor(e){super(new V(e))}}class V{constructor(e){o(this,"options");o(this,"ringBuffer");this.options={donePrefix:F,dataPrefix:U,parseData:!0,...e},this.ringBuffer=new v(this.options.bufferSize)}transform(e,t){if(!this.ringBuffer.write(e)){t.error(new Error("Buffer overflow. A single message or line might be larger than the buffer size."));return}this.processBuffer(t)}flush(e){this.processBuffer(e,!0)}processBuffer(e,t=!1){let r=0;for(;r<this.ringBuffer.occupied;){const s=this.findByte(M,r);if(s===-1){t&&this.ringBuffer.occupied>0&&(this.parseLine(e,this.ringBuffer.occupied),this.ringBuffer.consume(this.ringBuffer.occupied));break}const n=s-r;this.parseLine(e,n);const c=n+1;this.ringBuffer.consume(c),r=0}}parseLine(e,t){if(t===0)return;const r=this.ringBuffer.getView(0,t),s=R.decode(r);if(s.startsWith(this.options.dataPrefix)){const n=s.substring(this.options.dataPrefix.length);if(n.trim()===this.options.donePrefix){e.terminate();return}try{e.enqueue(this.options.parseData?JSON.parse(n):n)}catch(c){this.options.parseData?console.error("Failed to parse invalid JSON chunk:",n,"Error:",c):e.enqueue(n)}}}findByte(e,t){for(let r=t;r<this.ringBuffer.occupied;r++)if(this.ringBuffer.peekByte(r)===e)return r;return-1}}const q=new TextDecoder,P=10,A=13,J=58,z=32;class j extends TransformStream{constructor(e){super(new w(e))}}const y=class y{constructor(e){o(this,"dataBufferParts",[]);o(this,"eventTypeBuffer","");o(this,"lastEventIdBuffer","");o(this,"parseData");o(this,"metadata");o(this,"ringBuffer");this.parseData=(e==null?void 0:e.parseData)??!1,this.metadata=(e==null?void 0:e.metadata)??!1,this.ringBuffer=new v(e.bufferSize)}transform(e,t){this.ringBuffer.write(e),this.parseBuffer(t)}flush(e){this.dataBufferParts.length>0&&this.dispatchEvent(e)}parseBuffer(e){let t=0;for(;t<this.ringBuffer.occupied;){const r=this.ringBuffer.peekByte(t);if(r===P||r===A){let s=t,n=t+1;if(r===A&&t+1<this.ringBuffer.occupied&&this.ringBuffer.peekByte(t+1)===P&&(n=t+2),s>0){const c=this.ringBuffer.getView(0,s),m=q.decode(c);this.processLine(m)}else this.dispatchEvent(e);this.ringBuffer.consume(n),t=0;continue}t++}}processLine(e){if(e.charCodeAt(0)===J)return;const t=e.indexOf(":");let r,s;if(t===-1)r=e,s="";else{r=e.substring(0,t);let n=t+1;e.charCodeAt(n)===z&&n++,s=e.substring(n)}switch(r){case"event":this.eventTypeBuffer=s;break;case"data":this.dataBufferParts.push(s);break;case"id":s.indexOf("\0")===-1&&(this.lastEventIdBuffer=s);break;case"retry":s.length>0;for(let n=0;n<s.length;n++){const c=s.charCodeAt(n);if(c<48||c>57)break}break}}dispatchEvent(e){if(this.dataBufferParts.length===0){this.resetEventBuffers();return}let t=this.dataBufferParts.join(`
`);t.endsWith(`
`)&&(t=t.slice(0,-1));let r=t;if(this.parseData)try{r=JSON.parse(t)}catch(n){console.warn(n)}const s=this.metadata?{data:r,type:this.eventTypeBuffer||y.DEFAULT_EVENT_TYPE,lastEventId:this.lastEventIdBuffer}:r;e.enqueue(s),this.resetEventBuffers()}resetEventBuffers(){this.dataBufferParts.length=0,this.eventTypeBuffer=""}};o(y,"DEFAULT_EVENT_TYPE","message");let w=y;f.JSONStreamTransformer=H,f.SSEStreamTransformer=j,f.default=N,Object.defineProperties(f,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
